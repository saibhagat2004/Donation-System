<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Connection Tool</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .card {
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px 0;
        }
        button:hover {
            background-color: #45a049;
        }
        input {
            padding: 8px;
            width: 100%;
            margin: 5px 0;
            box-sizing: border-box;
        }
        #log {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
            min-height: 150px;
            margin-top: 20px;
            white-space: pre-wrap;
            font-family: monospace;
            overflow-y: auto;
            max-height: 300px;
        }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        .section {
            margin-bottom: 30px;
            border-bottom: 1px solid #eee;
            padding-bottom: 20px;
        }
        h2 {
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }
        .account-info {
            background-color: #f9f9f9;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .hint {
            color: #666;
            font-size: 0.8em;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <h1>Account Connection Tool</h1>
    <p>This tool helps you connect your funded account to the smart contract</p>
    
    <div class="section">
        <h2>1. Connect to Ganache</h2>
        <button onclick="connectToGanache()">Connect to Ganache</button>
        <div id="connection-status"></div>
    </div>
    
    <div class="section">
        <h2>2. Set Contract Address</h2>
        <input type="text" id="contract-address" placeholder="Enter contract address" value="0xe78A0F7E598Cc8b0Bb87894B0F60dD2a88d6a8Ab">
        <button onclick="setContractAddress()">Set Contract Address</button>
    </div>
    
    <div class="section">
        <h2>3. Your Account</h2>
        <input type="text" id="account-address" placeholder="Your account address" value="0x35b6cdc6F2a0990d38d232eEe6007846B531d5a0">
        <button onclick="checkAccount()">Check Account Balance</button>
        <div class="account-info" id="account-info">No account information yet</div>
    </div>
    
    <div class="section">
        <h2>4. Create NGO</h2>
        <input type="text" id="ngo-id" placeholder="NGO ID (e.g. NGO-123)" value="NGO-123">
        <div class="hint">Use text format like "NGO-123" or "RED-CROSS" - avoid using only numbers</div>
        <input type="number" id="initial-balance" placeholder="Initial balance (e.g. 10000)" value="10000">
        <button onclick="createInitialNgo()">Create NGO</button>
    </div>
    
    <div class="section">
        <h2>5. Record Donation</h2>
        <input type="text" id="donation-ngo-id" placeholder="NGO ID" value="NGO-123">
        <div class="hint">Must match exactly the NGO ID you created above</div>
        <input type="text" id="donation-donor-id" placeholder="Donor ID" value="DONOR1">
        <input type="text" id="donation-cause" placeholder="Cause" value="Education">
        <input type="number" id="donation-amount" placeholder="Amount" value="1000">
        <button onclick="recordDonation()">Record Donation</button>
    </div>
    
    <div class="section">
        <h2>6. Check NGO Data</h2>
        <input type="text" id="check-ngo-id" placeholder="NGO ID" value="NGO-123">
        <div class="hint">Must match exactly the NGO ID you created above</div>
        <button onclick="checkNgo()">Check NGO</button>
    </div>
    
    <div class="section">
        <h2>7. Test Contract Connection</h2>
        <button onclick="testContractConnection()">Test Contract Connection</button>
    </div>
    
    <div class="section">
        <h2>8. Go to Main Interface</h2>
        <button onclick="goToMainInterface()">Go to Main Interface</button>
    </div>
    
    <h2>Log</h2>
    <div id="log">Waiting for actions...</div>
    
    <script src="https://unpkg.com/ethers@6.10.0/dist/ethers.umd.js"></script>
    <script src="contract-abi.js"></script>
    <script>
        // Global variables
        let provider;
        let contract;
        let signer;
        
        // DOM elements
        const log = document.getElementById('log');
        const connectionStatus = document.getElementById('connection-status');
        const accountInfo = document.getElementById('account-info');
        
        // Helper functions
        function logMessage(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = type;
            entry.textContent = `[${timestamp}] ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
            console.log(`[${type}] ${message}`);
        }
        
        // Connect to Ganache
        async function connectToGanache() {
            try {
                logMessage('Connecting to Ganache...', 'info');
                provider = new ethers.JsonRpcProvider('http://127.0.0.1:7545');
                
                // Test connection
                const blockNumber = await provider.getBlockNumber();
                connectionStatus.innerHTML = `<span style="color:green">✅ Connected to Ganache. Current block: ${blockNumber}</span>`;
                logMessage(`Connected successfully. Block number: ${blockNumber}`, 'success');
                
                // Save connection details to localStorage
                localStorage.setItem('ganacheConnected', 'true');
            } catch (error) {
                connectionStatus.innerHTML = `<span style="color:red">❌ Connection failed: ${error.message}</span>`;
                logMessage(`Connection error: ${error.message}`, 'error');
            }
        }
        
        // Set contract address
        function setContractAddress() {
            try {
                const address = document.getElementById('contract-address').value;
                
                if (!address || !address.startsWith('0x')) {
                    throw new Error('Invalid contract address');
                }
                
                localStorage.setItem('donationContractAddress', address);
                logMessage(`Contract address set: ${address}`, 'success');
            } catch (error) {
                logMessage(`Error setting contract address: ${error.message}`, 'error');
            }
        }
        
        // Check account balance
        async function checkAccount() {
            try {
                if (!provider) {
                    throw new Error('Please connect to Ganache first');
                }
                
                const accountAddress = document.getElementById('account-address').value;
                
                if (!accountAddress || !accountAddress.startsWith('0x')) {
                    throw new Error('Invalid account address');
                }
                
                // Get balance
                const balance = await provider.getBalance(accountAddress);
                const balanceEth = ethers.formatEther(balance);
                
                accountInfo.innerHTML = `
                    <strong>Account:</strong> ${accountAddress}<br>
                    <strong>Balance:</strong> ${balanceEth} ETH<br>
                `;
                
                logMessage(`Account balance checked: ${balanceEth} ETH`, 'success');
                
                // Initialize signer with the contract owner's account
                try {
                    // Create a wallet with the contract deployer's private key
                    // This is your updated private key for the contract owner
                    const privateKey = '0x69c3cf937091d5c71fe45ca0e738e5c54c96ddc233e8b61f0590a0081c6fd4f8';
                    signer = new ethers.Wallet(privateKey, provider);
                    
                    const signerAddress = await signer.getAddress();
                    
                    if (signerAddress.toLowerCase() !== accountAddress.toLowerCase()) {
                        logMessage('NOTE: The signer address is different from the entered account address', 'info');
                        logMessage(`Signer address: ${signerAddress}`, 'info');
                        logMessage(`Entered address: ${accountAddress}`, 'info');
                        logMessage('Using the signer address as it has the contract owner permissions', 'info');
                        
                        // Update the displayed account address
                        document.getElementById('account-address').value = signerAddress;
                        
                        // Update account info display
                        const signerBalance = await provider.getBalance(signerAddress);
                        const signerBalanceEth = ethers.formatEther(signerBalance);
                        
                        accountInfo.innerHTML = `
                            <strong>Account (Contract Owner):</strong> ${signerAddress}<br>
                            <strong>Balance:</strong> ${signerBalanceEth} ETH<br>
                        `;
                    } else {
                        logMessage('Signer initialized successfully with matching address', 'success');
                    }
                } catch (error) {
                    logMessage(`Error initializing signer: ${error.message}`, 'error');
                    
                    // Fall back to using account from provider if possible
                    try {
                        signer = await provider.getSigner(accountAddress);
                        logMessage('Fallback: Signer initialized with account from provider', 'success');
                    } catch (fallbackError) {
                        logMessage(`Critical: Could not initialize signer: ${fallbackError.message}`, 'error');
                        return;
                    }
                }
                
                // Initialize contract
                initializeContract();
            } catch (error) {
                logMessage(`Error checking account: ${error.message}`, 'error');
                accountInfo.innerHTML = `<span style="color:red">Error: ${error.message}</span>`;
            }
        }
        
        // Initialize contract
        function initializeContract() {
            try {
                const address = localStorage.getItem('donationContractAddress');
                
                if (!address) {
                    throw new Error('Contract address not set');
                }
                
                if (!signer) {
                    throw new Error('No account selected');
                }
                
                // Initialize with both provider (for read operations) and signer (for write operations)
                contract = new ethers.Contract(address, CONTRACT_ABI, provider);
                
                // Connect with signer for transaction operations
                contract = contract.connect(signer);
                
                logMessage('Contract initialized successfully', 'success');
            } catch (error) {
                logMessage(`Error initializing contract: ${error.message}`, 'error');
            }
        }
        
        // Create initial NGO
        async function createInitialNgo() {
            if (!contract) {
                logMessage('Please connect to Ganache, set contract address, and check your account first', 'error');
                return;
            }
            
            try {
                const ngoId = document.getElementById('ngo-id').value.trim();
                const initialBalance = parseInt(document.getElementById('initial-balance').value);
                
                if (!ngoId) {
                    throw new Error('NGO ID is required');
                }
                
                // Validate NGO ID format - must be a string
                if (!isNaN(ngoId) && ngoId.trim() === ngoId) {
                    logMessage('Warning: NGO ID should be a string identifier. Consider using a prefix like "NGO-"', 'info');
                }
                
                if (isNaN(initialBalance) || initialBalance < 0) {
                    throw new Error('Initial balance must be a positive number');
                }
                
                logMessage(`Creating NGO "${ngoId}" with initial balance ${initialBalance}...`, 'info');
                
                // Record initial balance with current timestamp
                const timestamp = Math.floor(Date.now() / 1000);
                
                // Set gas limit explicitly
                const options = {
                    gasLimit: 500000
                };
                
                // Check if the signer is the contract owner
                try {
                    const owner = await contract.owner();
                    const signerAddress = await signer.getAddress();
                    
                    if (owner.toLowerCase() !== signerAddress.toLowerCase()) {
                        logMessage(`WARNING: Your account (${signerAddress}) is not the contract owner (${owner})`, 'error');
                        logMessage(`Only the contract owner can create NGOs. Transaction may fail.`, 'error');
                    }
                } catch (ownerError) {
                    logMessage(`Could not verify contract owner: ${ownerError.message}`, 'info');
                }
                
                const tx = await contract.recordInitialBalance(ngoId, initialBalance, timestamp, options);
                logMessage(`Transaction submitted: ${tx.hash}`, 'info');
                
                const receipt = await tx.wait();
                logMessage(`NGO created successfully! Transaction mined in block ${receipt.blockNumber}`, 'success');
                
                // Update all the NGO ID fields to match this one
                document.getElementById('donation-ngo-id').value = ngoId;
                document.getElementById('check-ngo-id').value = ngoId;
                logMessage(`All NGO ID fields updated to "${ngoId}"`, 'info');
            } catch (error) {
                logMessage(`Error creating NGO: ${error.message}`, 'error');
                
                if (error.message.includes("Only owner")) {
                    logMessage(`This operation requires the contract owner account. Make sure you're using the right account.`, 'info');
                }
            }
        }
        
        // Record donation
        async function recordDonation() {
            if (!contract) {
                logMessage('Please connect to Ganache, set contract address, and check your account first', 'error');
                return;
            }
            
            try {
                const ngoId = document.getElementById('donation-ngo-id').value.trim();
                const donorId = document.getElementById('donation-donor-id').value.trim();
                const cause = document.getElementById('donation-cause').value.trim();
                const amount = parseInt(document.getElementById('donation-amount').value);
                
                if (!ngoId || !donorId || !cause) {
                    throw new Error('All fields are required');
                }
                
                // Validate NGO ID format - must be a string
                if (!isNaN(ngoId) && ngoId.trim() === ngoId) {
                    logMessage('Warning: NGO ID should be a string identifier. Consider using a prefix like "NGO-"', 'info');
                }
                
                if (isNaN(amount) || amount <= 0) {
                    throw new Error('Amount must be a positive number');
                }
                
                logMessage(`Recording donation of ${amount} to "${ngoId}"...`, 'info');
                
                // Check if this NGO exists first
                try {
                    const balance = await contract.getNgoBalance(ngoId);
                    logMessage(`Found NGO "${ngoId}" with current balance: ${balance}`, 'info');
                } catch (balanceError) {
                    logMessage(`Warning: Could not verify if this NGO exists: ${balanceError.message}`, 'error');
                    logMessage('Creating a donation for a non-existent NGO will create it automatically', 'info');
                }
                
                // Get current timestamp
                const timestamp = Math.floor(Date.now() / 1000);
                
                // Set gas limit explicitly
                const options = {
                    gasLimit: 500000
                };
                
                const tx = await contract.recordDonation(ngoId, donorId, cause, amount, timestamp, options);
                logMessage(`Transaction submitted: ${tx.hash}`, 'info');
                
                const receipt = await tx.wait();
                logMessage(`Donation recorded successfully! Transaction mined in block ${receipt.blockNumber}`, 'success');
                
                // Update check NGO field to match this one
                document.getElementById('check-ngo-id').value = ngoId;
            } catch (error) {
                logMessage(`Error recording donation: ${error.message}`, 'error');
            }
        }
        
        // Check NGO data
        async function checkNgo() {
            if (!contract) {
                logMessage('Please connect to Ganache, set contract address, and check your account first', 'error');
                return;
            }
            
            try {
                const ngoId = document.getElementById('check-ngo-id').value;
                
                if (!ngoId) {
                    throw new Error('NGO ID is required');
                }
                
                // Validate NGO ID format - must be a string
                if (!isNaN(ngoId) && ngoId.trim() === ngoId) {
                    logMessage('Warning: NGO ID should be a string identifier. Using it as provided', 'info');
                }
                
                logMessage(`Checking data for NGO ${ngoId}...`, 'info');
                
                // Check for donations first to avoid balance errors
                try {
                    const donationCount = await contract.getIncomingDonationsCount();
                    logMessage(`Total donations in system: ${donationCount}`, 'info');
                    
                    // See if we can get active NGOs
                    if (donationCount > 0) {
                        try {
                            const activeNgos = await contract.getActiveNgoIds(100);
                            logMessage(`System has these NGOs: ${activeNgos.join(', ')}`, 'info');
                            
                            // Check if our NGO is in the list - using trimmed comparison
                            const ngoFound = activeNgos.some(id => id.trim() === ngoId.trim());
                            if (!ngoFound) {
                                logMessage(`WARNING: NGO "${ngoId}" not found in active NGOs list`, 'error');
                                // Check if there's a case issue or extra quotes
                                const possibleMatches = activeNgos.filter(id => 
                                    id.toLowerCase() === ngoId.toLowerCase() || 
                                    id.includes(ngoId) || 
                                    ngoId.includes(id));
                                if (possibleMatches.length > 0) {
                                    logMessage(`Possible matches found: ${possibleMatches.join(', ')}`, 'info');
                                }
                            } else {
                                logMessage(`NGO "${ngoId}" found in active NGOs list`, 'success');
                            }
                        } catch (e) {
                            logMessage(`Could not get active NGOs: ${e.message}`, 'error');
                        }
                    }
                } catch (e) {
                    logMessage(`Could not check donation count: ${e.message}`, 'error');
                }
                
                // Try a direct call through provider to check NGO balance - more reliable
                try {
                    // First try using the contract interface
                    try {
                        const balance = await contract.getNgoBalance(ngoId, { gasLimit: 500000 });
                        logMessage(`NGO Balance (contract call): ${balance.toString()}`, 'success');
                    } catch (contractCallError) {
                        logMessage(`Contract call failed, trying direct call: ${contractCallError.message}`, 'info');
                        
                        // Fallback to direct provider call
                        const contractAddress = localStorage.getItem('donationContractAddress');
                        const balanceFunctionSignature = 'getNgoBalance(string)';
                        const balanceAbi = ['function getNgoBalance(string memory ngoId) view returns (uint256)'];
                        const balanceInterface = new ethers.Interface(balanceAbi);
                        
                        const encodedData = balanceInterface.encodeFunctionData('getNgoBalance', [ngoId]);
                        
                        // Make the call through provider directly
                        const rawResult = await provider.call({
                            to: contractAddress,
                            data: encodedData
                        });
                        
                        // Decode the result
                        const decodedResult = balanceInterface.decodeFunctionResult('getNgoBalance', rawResult);
                        
                        logMessage(`NGO Balance (direct call): ${decodedResult[0].toString()}`, 'success');
                    }
                    
                    // If we got here, we can try the summary function
                    try {
                        // First try using the contract interface
                        try {
                            const summary = await contract.getNgoSummary(ngoId, { gasLimit: 500000 });
                            
                            logMessage(`=== NGO "${ngoId}" Summary (contract call) ===`, 'info');
                            logMessage(`Total Received: ${summary[0].toString()}`, 'info');
                            logMessage(`Total Spent: ${summary[1].toString()}`, 'info');
                            logMessage(`Incoming Transactions: ${summary[2].toString()}`, 'info');
                            logMessage(`Outgoing Transactions: ${summary[3].toString()}`, 'info');
                            logMessage(`Current Balance: ${summary[4].toString()}`, 'info');
                        } catch (contractSummaryError) {
                            logMessage(`Contract summary call failed, trying direct call: ${contractSummaryError.message}`, 'info');
                            
                            // Fallback to direct provider call
                            const summaryAbi = ['function getNgoSummary(string memory ngoId) view returns (uint256, uint256, uint256, uint256, uint256)'];
                            const summaryInterface = new ethers.Interface(summaryAbi);
                            
                            const encodedSummaryCall = summaryInterface.encodeFunctionData('getNgoSummary', [ngoId]);
                            
                            const rawSummaryResult = await provider.call({
                                to: contractAddress,
                                data: encodedSummaryCall
                            });
                            
                            const decodedSummary = summaryInterface.decodeFunctionResult('getNgoSummary', rawSummaryResult);
                            
                            logMessage(`=== NGO "${ngoId}" Summary (direct call) ===`, 'info');
                            logMessage(`Total Received: ${decodedSummary[0].toString()}`, 'info');
                            logMessage(`Total Spent: ${decodedSummary[1].toString()}`, 'info');
                            logMessage(`Incoming Transactions: ${decodedSummary[2].toString()}`, 'info');
                            logMessage(`Outgoing Transactions: ${decodedSummary[3].toString()}`, 'info');
                            logMessage(`Current Balance: ${decodedSummary[4].toString()}`, 'info');
                        }
                    } catch (summaryError) {
                        logMessage(`Could not retrieve detailed summary: ${summaryError.message}`, 'error');
                    }
                    
                } catch (directCallError) {
                    logMessage(`Direct call failed: ${directCallError.message}`, 'error');
                    
                    // Last resort - try the contract methods with options
                    try {
                        const options = { gasLimit: 1000000 };
                        const balance = await contract.getNgoBalance(ngoId, options);
                        logMessage(`NGO ${ngoId} balance through contract: ${balance.toString()}`, 'success');
                    } catch (fallbackError) {
                        logMessage(`All methods to get NGO data failed. This NGO likely doesn't exist yet.`, 'error');
                    }
                }
                
            } catch (error) {
                logMessage(`Error checking NGO data: ${error.message}`, 'error');
                
                // Provide more guidance
                logMessage('Make sure your contract address is correct and that you have created this NGO', 'info');
                logMessage('Try creating a new NGO with this ID using the "Create NGO" section above', 'info');
            }
        }
        
        // Test contract connection
        async function testContractConnection() {
            if (!contract) {
                logMessage('Please connect to Ganache, set contract address, and check your account first', 'error');
                return;
            }
            
            try {
                const contractAddress = localStorage.getItem('donationContractAddress');
                logMessage(`Testing contract connection to address: ${contractAddress}...`, 'info');
                
                // Display information about our connection
                logMessage(`Using account: ${await signer.getAddress()}`, 'info');
                
                // Try to directly check the contract's bytecode to verify it exists
                const contractCode = await provider.getCode(contractAddress);
                if (contractCode === '0x') {
                    logMessage('WARNING: No contract found at this address! Contract bytecode is empty.', 'error');
                    logMessage('Please check your contract address and make sure it was deployed correctly.', 'info');
                    return;
                }
                
                logMessage('Contract exists at the specified address', 'success');
                
                // Test basic contract functions
                try {
                    const owner = await contract.owner();
                    logMessage(`Contract owner address: ${owner}`, 'info');
                } catch (error) {
                    logMessage(`Failed to get owner: ${error.message}`, 'error');
                }
                
                try {
                    const totalDonations = await contract.totalDonations();
                    logMessage(`Total donations in contract: ${totalDonations}`, 'info');
                } catch (error) {
                    logMessage(`Failed to get totalDonations: ${error.message}`, 'error');
                }
                
                try {
                    const donationsCount = await contract.getIncomingDonationsCount();
                    logMessage(`Number of donation records: ${donationsCount}`, 'info');
                    
                    if (donationsCount > 0) {
                        // Try to get active NGOs
                        try {
                            const activeNgos = await contract.getActiveNgoIds(100);
                            logMessage(`Active NGOs found: ${activeNgos.length > 0 ? activeNgos.join(', ') : 'None'}`, 'info');
                        } catch (error) {
                            logMessage(`Could not get active NGOs: ${error.message}`, 'error');
                        }
                    }
                } catch (error) {
                    logMessage(`Failed to get donation count: ${error.message}`, 'error');
                }
                
                logMessage('Contract connection test completed', 'success');
            } catch (error) {
                logMessage(`Contract connection test failed: ${error.message}`, 'error');
                logMessage('Please check that your contract address is correct and the contract is deployed', 'info');
            }
        }
        
        // Go to main interface
        function goToMainInterface() {
            window.location.href = '/';
        }
        
        // Load saved data on page load
        document.addEventListener('DOMContentLoaded', function() {
            const savedAddress = localStorage.getItem('donationContractAddress');
            if (savedAddress) {
                document.getElementById('contract-address').value = savedAddress;
                logMessage(`Loaded saved contract address: ${savedAddress}`, 'info');
            }
        });
    </script>
</body>
</html>